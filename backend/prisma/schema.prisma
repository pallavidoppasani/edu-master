// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  INSTRUCTOR
  STUDENT
}

enum Level {
  BEGINNER
  INTERMEDIATE
  ADVANCED
}

enum QuizType {
  LESSON
  COURSE
  WEEKLY
}

model User {
  id            String         @id @default(uuid())
  email         String         @unique
  password      String
  name          String
  role          Role           @default(STUDENT)
  avatar        String?
  bio           String?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  
  // Relations
  coursesCreated Course[]      @relation("InstructorCourses")
  enrollments    Enrollment[]
  progress       Progress[]
  reviews        Review[]
  certificates   Certificate[]
  attempts       Attempt[]
  
  @@map("users")
}

model Course {
  id            String         @id @default(uuid())
  title         String
  slug          String         @unique
  description   String
  longDescription String?
  thumbnail     String?
  price         Int            @default(0)
  level         Level          @default(BEGINNER)
  category      String
  language      String         @default("English")
  published     Boolean        @default(false)
  instructorId  String
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  
  // Relations
  instructor    User           @relation("InstructorCourses", fields: [instructorId], references: [id], onDelete: Cascade)
  sections      Section[]
  enrollments   Enrollment[]
  reviews       Review[]
  certificates  Certificate[]
  announcements Announcement[]
  quizzes       Quiz[]
  
  @@map("courses")
}

model Section {
  id        String    @id @default(uuid())
  courseId  String
  title     String
  order     Int
  createdAt DateTime  @default(now())
  
  // Relations
  course    Course    @relation(fields: [courseId], references: [id], onDelete: Cascade)
  lessons   Lesson[]
  
  @@map("sections")
}

model Lesson {
  id          String     @id @default(uuid())
  sectionId   String
  title       String
  description String?
  videoUrl    String?
  duration    String?
  order       Int
  preview     Boolean    @default(false)
  createdAt   DateTime   @default(now())
  
  // Relations
  section     Section    @relation(fields: [sectionId], references: [id], onDelete: Cascade)
  progress    Progress[]
  quizzes     Quiz[]
  
  @@map("lessons")
}

model Enrollment {
  id          String    @id @default(uuid())
  userId      String
  courseId    String
  progress    Int       @default(0)
  paid        Boolean   @default(false)
  paymentAmount Int?
  paymentDate DateTime?
  enrolledAt  DateTime  @default(now())
  completedAt DateTime?
  
  // Relations
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  course      Course    @relation(fields: [courseId], references: [id], onDelete: Cascade)
  
  @@unique([userId, courseId])
  @@map("enrollments")
}

model Progress {
  id          String    @id @default(uuid())
  userId      String
  lessonId    String
  completed   Boolean   @default(false)
  completedAt DateTime?
  
  // Relations
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  lesson      Lesson    @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  
  @@unique([userId, lessonId])
  @@map("progress")
}

model Quiz {
  id           String     @id @default(uuid())
  lessonId     String?
  courseId     String?
  type         QuizType   @default(LESSON)
  title        String
  description  String?
  passingScore Int        @default(70)
  createdAt    DateTime   @default(now())
  
  // Relations
  lesson       Lesson?    @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  course       Course?    @relation(fields: [courseId], references: [id], onDelete: Cascade)
  questions    Question[]
  attempts     Attempt[]
  
  @@map("quizzes")
}

model Question {
  id            String   @id @default(uuid())
  quizId        String
  question      String
  options       Json     // Array of options
  correctAnswer String
  points        Int      @default(1)
  order         Int
  
  // Relations
  quiz          Quiz     @relation(fields: [quizId], references: [id], onDelete: Cascade)
  
  @@map("questions")
}

model Attempt {
  id          String   @id @default(uuid())
  userId      String
  quizId      String
  score       Int
  answers     Json     // User's answers
  submittedAt DateTime @default(now())
  
  // Relations
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  quiz        Quiz     @relation(fields: [quizId], references: [id], onDelete: Cascade)
  
  @@map("attempts")
}

model Review {
  id        String   @id @default(uuid())
  courseId  String
  userId    String
  rating    Int
  comment   String?
  createdAt DateTime @default(now())
  
  // Relations
  course    Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([courseId, userId])
  @@map("reviews")
}

model Certificate {
  id            String   @id @default(uuid())
  userId        String
  courseId      String
  certificateId String   @unique
  issuedAt      DateTime @default(now())
  
  // Relations
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  course        Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  
  @@unique([userId, courseId])
  @@map("certificates")
}

model Announcement {
  id        String   @id @default(uuid())
  courseId  String
  title     String
  content   String
  createdAt DateTime @default(now())
  
  // Relations
  course    Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  
  @@map("announcements")
}
